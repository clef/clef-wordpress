/*! Clef for WordPress - v2.4.1
 * http://getclef.com
 * Licensed GPLv2+ */
(function(e,t){var i;return i=function(){function t(){}return t.getErrorMessage=function(t){if("string"==typeof t)try{t=e.parseJSON(t)}catch(i){}return t.error?t.error:t.data&&t.data.error?t.data.error:t},t.getURLParams=function(){var e,t,i,s,n,r,o,a,u;for(i=window.location.search.substring(1),s=i.split("&"),t={},o=0,a=s.length;a>o;o++)n=s[o],u=n.split("="),e=u[0],r=u[1],t[e]=decodeURIComponent(r);return t},t}(),window.ClefUtils=i}).call(this,jQuery,Backbone),function(e,t){var i;return i=t.View.extend({el:"#invite-users-settings",events:{"click a[name='invite-users-button']":"inviteUsers"},messageTemplate:_.template("<div class='<%=type%> invite-users-message'><%=message%></div>"),showMessage:function(e){var t;return t=this.$el.find(".invite-users-message"),t.length&&t.remove(),this.$el.find(".invite-role-button").first().before(this.messageTemplate(e))},template:function(){return _.template(e("#invite-users-template").html())},initialize:function(e){return this.opts=e,this.opts.el?this.setElement(this.opts.el):void 0},inviteUsersAction:"clef_invite_users",inviteUsers:function(t){var i,s;return t.preventDefault(),e(t.target).attr("disabled","disabled"),i={_wpnonce:this.opts.nonces.inviteUsers,roles:e("select[name='invite-users-role']").val(),networkAdmin:this.opts.isNetworkSettings,action:this.inviteUsersAction},s=function(i){return function(s){var n;return n=ClefUtils.getErrorMessage(s),e(t.target).removeAttr("disabled"),i.showMessage({message:_.template(clefTranslations.messages.error.invite)({error:n}),type:"error"})}}(this),e.post(""+ajaxurl+"?action="+this.inviteUsersAction,i).success(function(i){return function(n){return e(t.target).removeAttr("disabled"),n.success?(i.trigger("invited"),i.showMessage({message:n.message,type:"updated"})):s(n)}}(this)).fail(function(e){return s(e.responseText)})},hideButton:function(){return this.$el.find(".button").hide()},render:function(){return this.$el.html(this.template)}}),this.InviteUsersView=i}.call(this,jQuery,Backbone),function(e){var t,i;return i=AjaxSettingsView.extend({el:"#multisite-settings",initialize:function(e){return this.modelClass=t,i.__super__.initialize.call(this,e)}}),t=AjaxSettingsModel.extend({parse:function(e,i){return i.url=ajaxurl+"?action=clef_multisite_settings",t.__super__.parse.call(this,e,i)},addActionToData:function(e){return e.action="clef_multisite_settings",e}}),this.MultisiteOptionsModel=t,this.MultisiteOptionsView=i}.call(this,jQuery),function(e,t){var i,s,n,r;return r=t.View.extend({el:e("#clef-tutorial"),messageTemplate:_.template("<div class='<%=type%> tutorial-message'><%=message%></div>"),events:{"click .next":"next","click .previous":"previous","click .done":"done"},slideClass:"sub",initialize:function(t){var i,s,r,o;for(this.opts=t,this.subs=[],i=this.$el.find("."+this.slideClass).filter(this.opts.slideFilterSelector),r=0,o=i.length;o>r;r++)s=i[r],this.subs.push(new n({el:s}));return this.currentSub=this.subs[0],e(window).on("message",this.handleMessages.bind(this)),this.hide(),this.render()},slideUp:function(e){return this.$el.slideUp(e)},hide:function(e){return this.$el.hide(e)},show:function(){return this.$el.fadeIn()},render:function(){return this.currentSub.render()},done:function(){return this.trigger("done")},next:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)+1],e?(e.isLogin()&&this.loggedIn&&(e=this.subs[_.indexOf(this.subs,this.newSub)+1]),this.currentSub.hide(),e.render(),this.currentSub=e,this.trigger("next")):this.done()},previous:function(){var e;return e=this.subs[_.indexOf(this.subs,this.currentSub)-1],e?(this.currentSub.hide(),e.render(),this.currentSub=e):void 0},handleMessages:function(e){var t;if(e.originalEvent.origin.indexOf(this.opts.clefBase)>=0)return t=e.originalEvent.data,"string"==typeof t&&(t=JSON.parse(t)),t},connectClefAccount:function(t,i){var s,n;return s={_wpnonce:this.opts.nonces.connectClef,identifier:t.identifier,state:t.state,action:this.connectClefAction},n=function(e){return function(t){var i;return i=ClefUtils.getErrorMessage(t),e.showMessage({message:_.template(clefTranslations.messages.error.connect)({error:i}),type:"error"})}}(this),e.post(""+ajaxurl+"?action="+this.connectClefAction,s).success(function(e){return e.success?"function"==typeof i?i(e):void 0:n(e)}).fail(function(e){return n(e.responseText)})},showMessage:function(t){return this.$currentMessage&&this.$currentMessage.remove(),this.$currentMessage=e(this.messageTemplate(t)).hide().prependTo(this.$el).slideDown(),t.removeNext?this.listenToOnce(this,"next",function(){return this.$currentMessage.slideUp()}):void 0}},{extend:t.View.extend}),n=t.View.extend({initialize:function(t){return this.opts=t,this.setElement(e(this.opts.el))},render:function(){return this.$el.show()},hide:function(){return this.$el.hide()},remove:function(){return this.$el.remove()},find:function(e){return this.$el.find(e)},isLogin:function(){return this.$el.find("iframe.setup").length},isSync:function(){return this.$el.hasClass("sync")&&this.$el.find("iframe").length}}),s=r.extend({connectClefAction:"connect_clef_account_clef_id",iframePath:"/iframes/application/create/v2",initialize:function(e){return e.slideFilterSelector=".setup",this.inviter=new InviteUsersView(_.extend({el:this.$el.find(".invite-users-container")},e)),this.listenTo(this.inviter,"invited",this.usersInvited),this.constructor.__super__.initialize.call(this,e),this.on("next",this.shouldLoadIFrame)},render:function(){return this.inviter.render(),this.constructor.__super__.render.call(this)},shouldLoadIFrame:function(){return this.currentSub.isSync()?this.loadIFrame(function(e){return function(){return e.currentSub.find(".spinner-container").hide(),e.iframe.fadeIn()}}(this)):void 0},loadIFrame:function(e){var t,i;if(!this.iframe)return this.iframe=this.$el.find("iframe.setup"),t=encodeURIComponent(this.opts.setup.affiliates.join(",")),i=""+this.opts.clefBase+this.iframePath+"?source="+encodeURIComponent(this.opts.setup.source)+"&domain="+encodeURIComponent(this.opts.setup.siteDomain)+"&logout_hook="+encodeURIComponent(this.opts.setup.logoutHook)+"&name="+encodeURIComponent(this.opts.setup.siteName)+"&affiliates="+t,this.iframe.attr("src",i),this.iframe.on("load",e)},handleMessages:function(e){return(e=this.constructor.__super__.handleMessages.call(this,e))?"keys"===e.type?this.connectClefAccount({identifier:e.clefID},function(t){return function(){return t.trigger("applicationCreated",e),t.next(),t.showMessage({message:clefTranslations.messages.success.connect,type:"updated",removeNext:!0})}}(this)):"error"===e.type?this.showMessage({message:_.template(clefTranslations.messages.error.create)({error:e.message}),type:"error"}):void 0:void 0},onConfigured:function(){return setTimeout(function(){return e(".logout-hook-error").slideDown()},2e4)},usersInvited:function(){return this.inviter.hideButton(),setTimeout(function(e){return function(){return e.currentSub.$el.hasClass("invite")?e.currentSub.$el.find(".button").addClass("button-primary"):void 0}}(this),1e3)}}),i=r.extend({render:function(){return this.addButton(),this.constructor.__super__.render.call(this)},addButton:function(){var t,i;if(!this.button)return t=window.location.href,t+=/\?/.test(t)?"&connect_clef_account=1":"?connect_clef_account=1",i=e("#clef-button-target").attr("data-app-id",this.opts.appID).attr("data-redirect-url",t).attr("data-state",this.opts.state).attr("data-embed",!0),this.button=new ClefButton({el:e("#clef-button-target")[0]}),this.button.render()}}),this.TutorialView=r,this.SetupTutorialView=s,this.ConnectTutorialView=i}.call(this,jQuery,Backbone),function(e){var t,i,s,n;return t=Backbone.View.extend({el:e("#clef-settings-container"),initialize:function(e){return this.opts=e,this.$msgContainer=this.$el.find(".message"),this.settings=new n(_.extend({options_name:"wpclef"},this.opts)),this.settings.hide(),this.settings.isConfigured()||(this.tutorial=new SetupTutorialView(_.extend({},this.opts)),this.tutorial.hide(),this.listenTo(this.tutorial,"message",this.displayMessage)),this.opts.isNetworkSettings&&(delete this.opts.formSelector,this.multisiteOptionsView=new MultisiteOptionsView(this.opts)),this.listenTo(this.settings,"message",this.displayMessage),this.render()},render:function(){return(this.opts.isUsingIndividualSettings||this.opts.isNetworkSettings&&this.opts.isNetworkSettingsEnabled)&&(this.multisiteOptionsView&&this.multisiteOptionsView.show(),this.settings.isConfigured()?this.settings.show():(this.tutorial.show(),this.listenToOnce(this.tutorial,"applicationCreated",this.configure),this.listenToOnce(this.tutorial,"done",this.hideTutorial))),this.$el.fadeIn()},configure:function(e){return this.settings.model.configure(e),this.settings.render()},displayMessage:function(e){return this.$msgContainer.find("p").text(e.message),this.$msgContainer.addClass(e.type).slideDown(),e.fade?setTimeout(function(){return this.$msgContainer.slideUp()},3e3):void 0},hideTutorial:function(){return this.settings.isConfigured()&&this.displayMessage(clefTranslations.messages.success.configured),this.tutorial.slideUp(),this.settings.show()}}),n=AjaxSettingsView.extend({errorTemplate:_.template("<div class='error form-error'><%=message%></div>"),genericErrorMessage:clefTranslations.messages.error.generic,addEvents:{"click .generate-override":"generateOverride","click .clef-settings__saveButton":"saveForm","click .clef-settings__resetButton":"resetForm","click a.show-support-html":"showSupportHTML"},constructor:function(e){return this.events=_.extend(this.events,this.addEvents),n.__super__.constructor.call(this,e)},initialize:function(e){return this.opts=e,this.modelClass=s,n.__super__.initialize.call(this,e),this.pro=new ClefProView(e,this.model),this.inviteUsersView=new InviteUsersView(e),this.formView=new i({model:this.model}),this.xmlEl=this.model.cFindInput("clef_password_settings_xml_allowed").parents(".input-container"),this.overrideContainer=this.$el.find(".override-settings"),this.setOverrideLink(),this.badgePreviewContainer=this.$el.find(".support-settings .ftr-preview"),this.listenTo(this.model,"change",this.clearErrors),this.listenTo(this.model,"error",this.error),window.onbeforeunload=function(e){return function(t){return e.isSaving()?clefTranslations.messages.saving:void 0}}(this),this.render()},updated:function(e,t){return n.__super__.updated.call(this,e,t),this.setOverrideLink()},render:function(){var t;return n.__super__.render.call(this),t=this.model.passwordsDisabled(),e("#clef-settings-header").show(),this.xmlEl.toggle(t),this.toggleOverrideContainer(t),this.overrideContainer.toggleClass("set",this.model.overrideIsSet()),this.inviteUsersView.render(),this.renderSupportBadge()},toggleInputs:function(e){return this.formView.toggleForm(!!parseInt(e.currentTarget.value))},toggleOverrideContainer:function(e){return this.overrideContainer.toggle(e)},generateOverride:function(){var e;return e=Math.random().toString(36).slice(2),this.model.save({"wpclef[clef_override_settings_key]":e})},setOverrideLink:function(){var e,t;return(t=this.model.overrideKey())?(this.overrideBase||(this.overrideBase=this.overrideContainer.find("label").text()),e=this.overrideContainer.find("a.button"),e.on("click",function(e){return e.preventDefault()}),e.attr("href",this.overrideBase+t)):void 0},isSaving:function(){return this.model.saving},renderSupportBadge:function(){var e;return e=this.model.badgeSetting(),this.badgePreviewContainer.toggle("disabled"!==e),this.badgePreviewContainer.find("a").toggleClass("pretty","badge"===e)},isConfigured:function(){return this.model.isConfigured()},saveForm:function(t){return t.preventDefault(),this.model.save({},{success:function(t){return function(){return t.trigger("message",{message:"Settings saved.",type:"updated"}),e("html, body").animate({scrollTop:0},"slow")}}(this),error:this.model.saveError.bind(this.model)})},resetForm:function(e){return e.preventDefault(),confirm("Are you sure you want to clear your settings?")?this.model.reset({success:function(){return window.location=window.location}}):void 0},showSupportHTML:function(t){return t.preventDefault(),e(".support-html-container").slideDown()}}),s=AjaxSettingsModel.extend({cFindInput:function(e){return this.findInput("wpclef["+e+"]")},cget:function(e){return this.get("wpclef["+e+"]")},passwordsDisabled:function(){return!!parseInt(this.cget("clef_password_settings_disable_passwords"))||""!==this.cget("clef_password_settings_disable_certain_passwords")||this.passwordsFullyDisabled()},passwordsFullyDisabled:function(){return!!parseInt(this.cget("clef_password_settings_force"))},loginIsEmbedded:function(){return!!parseInt(this.cget("clef_form_settings_embed_clef"))},overrideIsSet:function(){return!!this.overrideKey()},overrideKey:function(){return this.cget("clef_override_settings_key")},badgeSetting:function(){return this.cget("support_clef_badge").toLowerCase()},isConfigured:function(){return!(!this.cget("clef_settings_app_id")||!this.cget("clef_settings_app_secret"))},reset:function(e){return null==e&&(e={}),this.configure({appID:"",appSecret:""},e)},configure:function(e,t){var i,s,n,r;if(null==t&&(t={}),s={"wpclef[clef_settings_app_id]":e.appID,"wpclef[clef_settings_app_secret]":e.appSecret},e.configuration){r=e.configuration;for(i in r)n=r[i],s["wpclef["+i+"]"]=n}return this.save(s,t)}}),i=Backbone.View.extend({el:e("#login-form-view"),template:function(){return _.template(e("#form-template").html())},initialize:function(e){return this.opts=e,this.model=this.opts.model,this.listenTo(this.model,"change",this.toggleForm),this.render()},render:function(){return this.$el.html(this.template),this.$el.find('input[type="submit"]').on("click",function(e){return e.preventDefault()}),this.toggleForm()},toggleForm:function(e){return this.$el.toggleClass("only-clef",this.model.passwordsFullyDisabled()),this.$el.toggleClass("embed-clef",this.model.loginIsEmbedded())}}),this.AppView=t,e.fn.serializeObject=function(t){var i,s,n,r,o;for(s={},o=e(this).serializeArray(),n=0,r=o.length;r>n;n++)i=o[n],s[i.name]=i.value;return s}}.call(this,jQuery),function(e,t){var i;return i=t.View.extend({el:"#connect-clef-account",events:{"click #disconnect":"disconnectClefAccount"},disconnectAction:"disconnect_clef_account",messageTemplate:_.template("<div class='<%=type%> connect-clef-message'><%=message%></div>"),initialize:function(e){return this.opts=e,this.tutorial=new ConnectTutorialView(_.clone(this.opts)),this.disconnect=this.$el.find(".disconnect-clef"),this.listenTo(this.tutorial,"done",this.finishTutorial),this.render()},show:function(){return this.$el.fadeIn()},render:function(){return this.tutorial.render(),this.opts.connected?(this.tutorial.slideUp(),this.disconnect.show()):(this.disconnect.hide(),this.tutorial.show())},disconnectClefAccount:function(t){var i,s;return t.preventDefault(),s=function(e){return function(t){var i;return i=ClefUtils.getErrorMessage(t),e.showMessage({message:_.template(clefTranslations.messages.error.disconnect)({error:i}),type:"error"})}}(this),i={action:this.disconnectClefAction,_wpnonce:this.opts.nonces.disconnectClef},e.post(""+ajaxurl+"?action="+this.disconnectAction,i).success(function(e){return function(t){var i;return t.success?(e.opts.connected=!1,e.render(),i=clefTranslations.messages.success.disconnect,e.showMessage({message:i,type:"updated"})):s(t)}}(this)).fail(function(e){return s(e.responseText)})},showMessage:function(t){return this.message&&this.message.remove(),this.message=e(this.messageTemplate(t)).hide(),this.message.prependTo(this.$el).slideDown()},finishTutorial:function(){return window.location=""}}),window.ConnectView=i}.call(this,jQuery,Backbone);var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};(function(e,t){var i,s;return s=t.View.extend({el:"#clef-pro-section",getServicesURL:ajaxurl+"?action=clef_get_pro_services",subViews:[],initialize:function(t,s){return this.opts=t,this.model=s,e.getJSON(this.getServicesURL,{_wpnonce:this.opts.nonces.getProServices}).success(function(e){return function(t){return e.servicesAvailable=t,__indexOf.call(e.servicesAvailable,"customize")>=0&&(e.customizer=new i(e.opts,e.model),e.subViews.push(e.customizer)),e.render()}}(this)).fail(function(e){return console.log(e.responseText)})},render:function(){var e,t,i,s;for(s=this.subViews,t=0,i=s.length;i>t;t++)e=s[t],e.render();return this.$el.show()}}),i=t.View.extend({el:"#clef-pro-customization",events:{"click #clef-custom-logo-upload":"openMediaUploader","click #clef-custom-logo-clear":"clearLogo","change input, change textarea":"render","keyup textarea":"render"},initialize:function(t,i){return this.opts=t,this.model=i,this.preview=_.template(e("#clef-customization-template").html())},render:function(){return this.$el.find("#custom-login-view").html(this.preview({image:this.image(),message:this.message()})),this.$el.find("#clef-custom-logo-clear").toggle(!!this.image()),this.$el.show()},openMediaUploader:function(){return this.uploader?void this.uploader.open():(this.uploader=wp.media.frames.file_frame=wp.media({title:"Choose an image",button:{text:"Choose an image"},multiple:!1}),this.uploader.on("select",function(e){return function(){var t;return t=e.uploader.state().get("selection").first().toJSON(),e.model.save({"wpclef[customization_logo]":t.url}),e.render()}}(this)),this.uploader.open())},clearLogo:function(){return this.model.save({"wpclef[customization_logo]":""}),this.render()},image:function(){return this.model.cget("customization_logo")},message:function(){return this.$el.find("textarea").val()}}),window.ClefProView=s}).call(this,jQuery,Backbone);